doctype html
html
  head
    include ../partials/head.jade
  body
  .header
    span.userName Howdy #{user.username}
    |  
    .profile-headshot
      if headshot
        img.placeholder(src=headshot height="75" width="75")
        a.plus-overlay(href="/profile-picture")
          img(src='/plus-overlay.png' height="75" width="75")
      else  
        img.placeholder(src="/avatar.png" height="75" width="75")
        a.plus-overlay(href="/profile-picture")
          img(src='/plus-overlay.png' height="75" width="75")
    a.home-logout.btn.btn-default( href="/begin" ) My Profile
    | 
    a.home-logout.btn.btn-default( href="/logout" ) Log Out

  .container
    .imagesList
      if(imageURLs)
        h3 Current Picture
        each imageURL, index in imageURLs
          if imageURL[0] == profilePictureFilename
            .image-summary-image
              img(src=imageURL[1] height="300" width="400", id=imageURL[0])
        h3 Select a different Picture
        each imageURL, index in imageURLs
          if imageURL[0] != profilePictureFilename
            a
              img.imageListItems(src=imageURL[1], id=imageURL[0])
        .view-all-images-btn
          a#resetPicture.btn.btn-default() Set Profile Image
    form(role='form', id="headshotForm" action="/add-profile-headshot", method="post", data-idea-doc=idea, enctype="multipart/form-data")
      .form-group
        h3 Upload a new User Profile Picture
        |  
        input#headshotButton(type="file", name="picture")
        br
    a.home-logout.btn.btn-default( href="/idea-summary" ) < Back to Idea Summary
          


  include ../partials/js-includes.jade
  script(type="text/javascript").
    /* document.getElementById("headshotButton").onchange = function() {
      document.getElementById("headshotForm").submit();
    }; */

    document.getElementById("headshotButton").onchange = function(event) {
      const files = document.getElementById('headshotButton').files;
      const file = files[0];
      if(file == null){
        return alert('No file selected.');
      }

      if(file.size < 1000000){
        getSignedRequest(file);
      } else if (file.size > 1000000){
        alert('Please choose an image smaller than 1 MB.')
      } else {
        alert('An error ocurred with this image.')
      }
    };

    function uploadFile(file, signedRequest, url){
      const xhr = new XMLHttpRequest();
      xhr.open('PUT', signedRequest);
      xhr.onreadystatechange = function() {
        if(xhr.readyState === 4){
          if(xhr.status === 200 && (file.type=="image/jpeg" || file.type=="image/png")){
            var data = {"filename" : file.name, "fileUrl" : url, "type" : file.type };
            $(".image-summary-image img").attr("src", url);
            $.post('/add-profile-headshot', data , function(response, status){
              window.location.reload();
            });
          }
          else{
            alert('Could not upload file.');
          }
        }
      };
      xhr.send(file);
    }

    function getSignedRequest(file){
      const xhr = new XMLHttpRequest();
      xhr.open('GET', '/sign-s3?file-name='+file.name + '&file-type='+ file.type);
      xhr.onreadystatechange = function() {
        if(xhr.readyState === 4){
          if(xhr.status === 200){
            const response = JSON.parse(xhr.responseText);
            uploadFile(file, response.signedRequest, response.url);
          }
          else{
            alert('Could not get signed URL.');
          }
        }
      };
      xhr.send();
    }


    $("a img").click(function(event){
      $(".selectedProfilePic").removeClass("selectedProfilePic");
      $(this).addClass("selectedProfilePic");
    });

    $("#resetPicture").click(function(event){
      var data = {
        "newPictureFilename" : $(".selectedProfilePic").attr("id")
      };

      $.post("/set-existing-profile-pic", data, function(data, response) {
        window.location.reload();
      });
    });